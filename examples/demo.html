<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-Control" content="no-transform" />
    <title>input</title>

    <meta name="applicable-device" content="mobile" />
    <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="format-detection" content="telephone=no">


    <meta name="description" content="{{description}}" name="description">
    <style>
        .active,
        .value-container-list:hover {
            color: #ffffff;
            background: #007fff;
        }

        .value-container-list {
            cursor: pointer;
        }
    </style>
</head>

</html>

<body>
    <div class="input-container">
        <input type="text" id="input">
        <div class="value-container">

        </div>
    </div>
    <script>
        // 添加事件
        function addEvent(element, eventName, callback) {
            if (element.addEventListener) {
                element.addEventListener(eventName, callback, false);
            } else if (element.attachEvent) {
                element.attachEvent("on" + eventName, callback);
            } else {
                element["on" + eventName] = callback;
            }
        }
        // 增加class
        function addClass(element, className) {
            element.classList.add(className);
        }
        // 去除class
        function removeClass(element, className) {
            element.classList.remove(className);
        }
        addEvent(document, "DOMContentLoaded", function () {
            var $input = document.querySelector('#input'),
                $valueContainer = document.querySelector(".value-container"),
                searchTarget = ['aaa', 'abc', 'bbc', 'adc', 'ccc'],
                inputFocus = false,
                active = 0,
                searchResult = [],
                resultLength = 0,
                keyMap = {
                    up: 38,
                    down: 40,
                    enter: 13,
                }

            function init() {
                active = 0;
                searchResult = [];
                resultLength = 0;
            }
            // function removeChildNodes(element) {
            //     while(element.firstChild) {
            //         element.removeChild(element.firstChild)
            //     }
            // }
            function inputVal() {
                return $input.value;
            }

            function dealInputChange() {
                console.log("input change");

                var inputValue = inputVal();
                if (inputValue) {
                    searchResult = search(inputValue);
                };
                $valueContainer.innerHTML = '';
                searchResult.forEach(function (val, idx) {
                    createEle(val);
                    resultLength++;
                });

                console.log(searchResult);
            }

            function inputChange() {
                init();
                dealInputChange();
            }

            function createEle(text) {
                var inputList = document.createElement('div');
                inputList.className = "value-container-list"
                inputList.innerText = text;
                $valueContainer.appendChild(inputList);
            }

            function search(val) {
                return searchTarget.filter(function (value, idx) {
                    return new RegExp('^' + val).test(value);
                })
            }

            $input.oninput = inputChange;
            $input.onpropertychange = $input.oninput;
            // addEvent($input,"focus",function(){
            //     inputFocus = true;
            //     // inputChange();
            //     dealInputChange();
            // });
            // addEvent($input,"blur",function(){
            //     inputFocus = false;
            //     init();
            //     $valueContainer.innerHTML='';
            // });
            addEvent(document, "click", function (e) {
                var target = e || window.event;
                if (e.target.className == "value-container-list") {
                    console.log(e.target.innerText);
                    $input.value = e.target.innerText;
                    $valueContainer.innerHTML = '';
                } else if (e.target == document.querySelector('#input')) {
                    inputFocus = true;
                    // inputChange();
                    dealInputChange();
                } else {
                    if (!inputFocus) return;
                    inputFocus = false;
                    init();
                    $valueContainer.innerHTML = '';
                }
            });

            // refer to https://github.com/jaywcjlove/hotkeys/blob/master/src/hotkeys.js
            // 返回键码
            function code(x) {
                return keyMap[x.toLowerCase()] || x.toUpperCase().charCodeAt(0);
            }
            // 处理键盘事件
            addEvent(document, "keydown", function (e) {
                if (!inputFocus) return;
                e = e || window.event;
                var keyCode = e.keyCode || e.which || e.charCode;
                if (typeof (keyCode) === 'string') {
                    keyCode = code(keyCode); // 转换成键码
                }
                console.log(keyCode);
                switch (keyCode) {
                    case 38:
                        keyUp();
                        break;
                    case 40:
                        keyDown();
                        break;
                    case 13:
                        keyEnter();
                        break;
                    default:
                        return;
                        break;
                }
            });

            function activeList(idx) {
                addClass(document.querySelectorAll(".value-container-list")[idx], "active");
            }

            function unActiveList(idx) {
                removeClass(document.querySelectorAll(".value-container-list")[idx], "active");
            }
            // 键盘向上
            function keyUp() {
                console.log("active", active);
                if (active <= 1 || resultLength === 0) return;
                active--;
                unActiveList(active);
                activeList(active - 1);


            }
            // 键盘向下
            function keyDown() {
                if (active === resultLength || resultLength === 0) return;
                if (active > 0) {
                    unActiveList(active - 1);
                }
                activeList(active);
                active++;
            }
            // 键盘enter
            function keyEnter() {
                if (active === 0) return;
                $input.value = searchResult[active - 1];
                $valueContainer.innerHTML = '';
                init();
            }
        })
    </script>
</body>